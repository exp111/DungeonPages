<!DOCTYPE html>
<html>

<head>
    <title>Dungeon Pages</title>
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/dice.css" />
    <link rel="stylesheet" type="text/css" href="css/character.css" />
    <link rel="stylesheet" type="text/css" href="css/map.css" />
</head>

<body>
    <div class="wrapper">
        <div id="dice">

        </div>
        <div class="game">
            <div id="character">

            </div>
            <div id="map">

            </div>
        </div>
    </div>
    <script src="js/dice.js"></script>
    <script src="js/map.js"></script>
    <script src="js/character.js"></script>
    <script src="js/data.js"></script>
    <script>
        Global = {
            dice: null,
            map: null,
            character: null,
            selectedDice: null,
        };
        // Dice
        Global.dice = new DicePool();
        let d = document.getElementById("dice");
        d.parentNode.replaceChild(Global.dice.DOMObject, d);
        Global.dice.OnDiceClick = (e) => OnDiceClick(e.dice);
        // Character
        loadCharacterJson("zafinn.json").then((json) => {
            let char = Character.FromJson(json);
            let c = document.getElementById("character");
            c.parentNode.replaceChild(char.DOMObject, c);
            Global.character = char;
            console.log(Global.character);
        });
        // Map
        loadMapJson("highmountVillage.json").then((json) => {
            let map = Map.FromJson(json);
            let m = document.getElementById("map");
            m.parentNode.replaceChild(map.DOMObject, m);
            Global.map = map;
            Global.map.OnTileClick = (e) => OnTileClick(e.dungeon, e.tile);
            console.log(Global.map);
        });

        function OnTileClick(dungeon, tile) {
            console.log(`Clicked tile ${tile.Type} (${tile.X}, ${tile.Y}) in dungeon ${dungeon.Name}`);
            if (Global.selectedDice == null) {
                console.log("No dice selected")
                return;
            }
            let dice = Global.selectedDice;
            if (!tile.CanBeMarked()) {
                console.log("Tile can't be marked");
                return;
            }
            tile.Value = dice.Value;
            tile.UpdateUI();
            // use dice
            dice.Used = true;
            dice.UpdateUI();
        }

        function OnDiceClick(dice) {
            console.log(`Clicked dice ${dice}`);
            // check if dice was used
            if (dice.Used) {
                console.log("Dice was already used");
                return;
            }
            Global.selectedDice = dice;
            //TODO: make selection visible
        }
    </script>
</body>

</html>