<!DOCTYPE html>
<html>

<head>
    <title>Dungeon Pages</title>
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/dice.css" />
    <link rel="stylesheet" type="text/css" href="css/character.css" />
    <link rel="stylesheet" type="text/css" href="css/map.css" />
</head>

<body>
    <div class="wrapper">
        <div id="dice">

        </div>
        <div class="game">
            <div id="character">

            </div>
            <div id="map">

            </div>
        </div>
    </div>
    <script src="js/dice.js"></script>
    <script src="js/map.js"></script>
    <script src="js/character.js"></script>
    <script src="js/data.js"></script>
    <script>
        Global = {
            dice: null,
            map: null,
            character: null,
            selectedDice: null,
        };
        // Dice
        Global.dice = new DicePool();
        let d = document.getElementById("dice");
        d.parentNode.replaceChild(Global.dice.DOMObject, d);
        Global.dice.OnDiceClick = (e) => OnDiceClick(e.dice);
        Global.dice.OnButtonClick = (e) => OnDicePoolButton();
        // Character
        loadCharacterJson("zafinn.json").then((json) => {
            let char = Character.FromJson(json);
            let c = document.getElementById("character");
            c.parentNode.replaceChild(char.DOMObject, c);
            Global.character = char;
            console.log(Global.character);
        });
        // Map
        loadMapJson("highmountVillage.json").then((json) => {
            let map = Map.FromJson(json);
            let m = document.getElementById("map");
            m.parentNode.replaceChild(map.DOMObject, m);
            Global.map = map;
            Global.map.OnDungeonClick = (e) => OnDungeonClick(e.dungeon);
            Global.map.OnTileClick = (e) => OnTileClick(e.dungeon, e.tile);
            console.log(Global.map);
        });

        function OnDungeonClick(dungeon) {
            console.log(`Clicked dungeon ${dungeon.Name}`);
            let map = Global.map;
            let character = Global.character;
            if (map.CanSelectDungeon(dungeon) && !character.IsDead()) {
                map.SelectDungeon(dungeon);
                let pool = Global.dice;
                pool.SetAvailableDice(pool.AvailableGood, dungeon.Dice);
            }
        }

        function OnTileClick(dungeon, tile) {
            console.log(`Clicked tile ${tile.Type} (${tile.GetID()}) in dungeon ${dungeon.Name}`);

            if (!dungeon.Active) {
                console.error(`Dungeon ${dungeon.Name} is not active`);
                return;
            }
            let dice = Global.dice;
            if (!dice.CanUseDice())
                return;

            if (!tile.CanBeMarked())
                return;

            let char = Global.character;
            if (!dungeon.CanReachTile(tile, char))
                return;

            // use dice
            if (!dice.UseDice(tile))
                return;
            // check for item collection/monster defeat
            dungeon.CheckForCollection(tile, Global.map.Monsters);

            // Need to recheck fully everytime
            if (dungeon.IsFinished()) {
                console.log(`Finished Dungeon ${dungeon.Name}`);
                Global.map.FinishDungeon();
                // check if there is a sequential path
                if (dungeon.IsFinished(true)) {
                    //TODO: move this into the map?
                    let rewards = dungeon.CalculateXP();
                    let xp = rewards.xp;
                    let enemies = rewards.enemies;
                    let monsterXP = Global.map.GetMonsterXP(enemies);
                    let total = xp + monsterXP;
                    console.log(`Got ${total} experience. (${xp} + ${monsterXP})`);
                    // give rewards to the player
                    char.GotExperience(total);
                    dice.SetAvailableDice(char.GoodDice, 0);
                    //TODO: allow player to choose weapon/relic
                } else {
                    console.log("Dungeon did not finish with a sequential path");
                }
                return;
            }

            // check for trap, needs to be done after item collection + dungeon finish
            Global.map.CheckTrap(tile);
        }

        function OnDicePoolButton() {
            console.log(`Clicked reroll`);
            let map = Global.map;
            if (!map.HasActiveDungeon()) {
                console.log("No active dungeon");
                return;
            }
            let pool = Global.dice;
            let results = pool.Reroll();
            if (!results) {
                console.log("Not all dice rolled");
                return;
            }
            console.debug(results);
            let damage = 0;
            if (map.CheckWanderingMonsters(results)) {
                console.log("Natural Doubles activated Wandering Monsters effect.");
                damage += 1;
            }
            damage += map.CheckMonsterAttack(results);
            if (damage > 0) {
                console.log(`Received ${damage} damage`);
                // give the player damage
                Global.character.GotDamage(damage);
                // check for death
                if (Global.character.IsDead()) {
                    Global.map.UnselectDungeon();
                    //TODO: notify the user
                }
            }
        }

        function OnDiceClick(dice) {
            console.log(`Clicked dice ${dice}`);
            Global.dice.SelectDice(dice);
        }
    </script>
</body>

</html>